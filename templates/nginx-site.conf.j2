####
# NGinX virtual server configuration for {{ inventory_hostname }}
####
# redirect http:/{{ inventory_hostname }} to https
server {
   listen 80;
   server_name {{ inventory_hostname }};
   return 301 https://{{ inventory_hostname }}$request_uri;
}

# redirect www
server {
   server_name ~^www\.;
   return 301 https://{{ inventory_hostname }}$request_uri;
}

# redirect .com.uy
server {
   server_name ~(.com.uy$);
   return 301 https://{{ inventory_hostname }}$request_uri;
}

# redirect vivaz
server {
   server_name ~^vivaz\.;
   return 301 https://{{ inventory_hostname }}$request_uri;
}

# service {{ inventory_hostname }} on https: port 443 with SSL
server {
  listen 443;
  server_name {{ inventory_hostname }};

  # TODO template the location
  ssl on;
  ssl_certificate     /etc/letsencrypt/live/{{ inventory_hostname }}/fullchain.pem;
  ssl_certificate_key /etc/letsencrypt/keys/0001_key-certbot.pem;

  root /home/{{ ansible_user }}/{{ inventory_hostname}}/current/public;
  passenger_enabled on;
  client_max_body_size 15M;

  #error page handling
  error_page  404  @404;
  #location @404 {
    #rewrite ^(.*)$ /404.html break;
  #}
  error_page  500 502 504  @50x;
  location = @50x {
      root   html;
  }
  recursive_error_pages on;
  if (-f $document_root/system/maintenance.html) {
    return 503;
  }
  error_page 503 = @maintenance;
  location @maintenance {
    error_page 405 /503.html;
    if (-f $request_filename) {
      break;
    }
    rewrite ^(.*)$ /503.html break;
  }
  # expire assets more or less never
  # from http://guides.rubyonrails.org/asset_pipeline.html#asset-organization
  location ~ ^/assets/ {
    expires 1y;
    add_header Cache-Control public;
    add_header ETag "";
  }
}
